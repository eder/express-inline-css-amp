{"version":3,"sources":["../src/index.js"],"names":["NODE_ENV","process","env","InlineCSSAMP","constructor","CSSPathBase","CSSFilePath","CSSMinify","outFile","version","CSSOutDefault","pathToReadCSS","generateCSS","view","response","fs","existsSync","outFileTemp","CSSFilePathTemp","Promise","resolve","reject","options","file","outputStyle","console","log","sass","render","err","result","error","writeFile","css","readCSS","readFile","run","tagStyle","html","content","er","test","replace","module","exports","object","inlinecss","req","res","next","renderCallback","then","send","Render","renders","callback"],"mappings":";;;;;;;AAAA;;;;AACA;;;;;;AAEA,MAAMA,QAAQ,GAAGC,OAAO,CAACC,GAAR,CAAYF,QAA7B;;AAEO,MAAMG,YAAN,CAAmB;AACxBC,EAAAA,WAAW,CAAC;AACVC,IAAAA,WADU;AAEVC,IAAAA,WAFU;AAGVC,IAAAA,SAAS,GAAG,IAHF;AAIVC,IAAAA,OAJU;AAKVC,IAAAA;AALU,GAAD,EAMR;AACD,SAAKC,aAAL,GAAsB,2CAA0CD,OAAQ,MAAxE;AACA,SAAKH,WAAL,GAAmBA,WAAnB;AACA,SAAKC,SAAL,GAAiBA,SAAjB;AACA,SAAKF,WAAL,GAAmBA,WAAnB;AACA,SAAKG,OAAL,GAAeA,OAAO,IAAI,KAAKE,aAA/B;AACA,SAAKD,OAAL,GAAeA,OAAf;AACA,SAAKE,aAAL,GAAsB,KAAKH,OAA3B;AACD;;AAED,QAAMI,WAAN,CAAkBC,IAAlB,EAAwB;AACtB,SAAKF,aAAL,GAAsB,GAAE,KAAKN,WAAY,GAAEQ,IAAK,OAAhD;;AACA,UAAMC,QAAQ,GAAGC,aAAGC,UAAH,CAAe,GAAE,KAAKX,WAAY,GAAEQ,IAAK,OAAzC,CAAjB;;AACA,QAAIC,QAAJ,EAAc;AACZ,WAAKG,WAAL,GAAoB,2CAA0C,KAAKR,OAAQ,IAAGI,IAAK,OAAnF;AACA,WAAKK,eAAL,GAAuB,KAAKP,aAA5B;AACD,KAHD,MAGO;AACL,WAAKO,eAAL,GAAuB,KAAKZ,WAA5B;AACA,WAAKK,aAAL,GAAqB,KAAKH,OAA1B;AACA,WAAKS,WAAL,GAAoB,KAAKT,OAAzB;AACD;;AAGD,WAAO,IAAIW,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAIC,OAAO,GAAG;AACZC,QAAAA,IAAI,EAAE,KAAKL,eADC;AAEZV,QAAAA,OAAO,EAAE,KAAKS,WAFF;AAGZO,QAAAA,WAAW,EAAE,KAAKjB,SAAL,GAAiB,YAAjB,GAAgC;AAHjC,OAAd;;AAMA,UAAIP,QAAQ,IAAI,aAAhB,EAA+B;AAC7ByB,QAAAA,OAAO,CAACC,GAAR,CAAY,YAAZ;;AACA,YAAIX,aAAGC,UAAH,CAAc,KAAKC,WAAnB,KAAmCF,aAAGC,UAAH,CAAc,KAAKN,aAAnB,CAAvC,EAA0E;AACxE,iBAAQU,OAAO,EAAf;AACD,SAFD,MAEO;AACL,cAAG,CAACL,aAAGC,UAAH,CAAc,KAAKE,eAAnB,CAAD,IAAwCH,aAAGC,UAAH,CAAc,KAAKN,aAAnB,CAA3C,EAA8E;AAC5E,mBAAQU,OAAO,EAAf;AACD;AACF;AACF;;AAED,UAAI;AACFO,2BAAKC,MAAL,CAAYN,OAAZ,EAAqB,CAACO,GAAD,EAAMC,MAAN,KAAiB;AACpC,cAAGD,GAAH,EAAQ;AACNJ,YAAAA,OAAO,CAACM,KAAR,CAAcF,GAAd;AACA,mBAAOR,MAAM,CAACQ,GAAD,CAAb;AACD;;AACDd,uBAAGiB,SAAH,CAAa,KAAKf,WAAlB,EAA+Ba,MAAM,CAACG,GAAtC,EAA2C,UAASJ,GAAT,EAAa,CACvD,CADD;AAED,SAPD;AAQD,OATD,CAUA,OAAMA,GAAN,EAAW;AACT,cAAMA,GAAN;AACD;;AACDT,MAAAA,OAAO;AACR,KAhCM,CAAP;AAiCD;;AAEDc,EAAAA,OAAO,GAAG;AACR,WAAO,IAAIf,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAI;AACFN,qBAAGoB,QAAH,CAAY,KAAKxB,aAAjB,EAAgC,MAAhC,EAAwC,CAACkB,GAAD,EAAMN,IAAN,KAAe;AACrD,iBAAOH,OAAO,CAACG,IAAD,CAAd;AACD,SAFD;AAGD,OAJD,CAKA,OAAMM,GAAN,EAAW;AACT,cAAMA,GAAN;AACD;AACF,KATM,CAAP;AAUD;;AAED,QAAMO,GAAN,CAAWvB,IAAX,EAAiB;AACf,UAAM,KAAKD,WAAL,CAAiBC,IAAjB,CAAN;AACA,WAAO,KAAKqB,OAAL,EAAP;AACD;;AAEDG,EAAAA,QAAQ,CAACC,IAAD,EAAOC,OAAP,EAAgB;AACtB,UAAMC,EAAE,GAAG,aAAX;AACA,QAAI,CAACA,EAAE,CAACC,IAAH,CAAQH,IAAR,CAAL,EAAoB,OAAOA,IAAP;AACpB,WAAOA,IAAI,CAACI,OAAL,CAAaF,EAAb,EAAkB,qBAAoBD,OAAQ,YAA9C,CAAP;AACD;;AAvFuB;;QAAbpC,Y,GAAAA,Y;;AA0FbwC,MAAM,CAACC,OAAP,GAAiBC,MAAM,IAAI;AACzB,QAAMC,SAAS,GAAG,IAAI3C,YAAJ,CAAiB0C,MAAjB,CAAlB;;AACA,QAAMjB,MAAM,GAAG,CAACmB,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;AACjC,UAAMC,cAAc,GAAG,UAASrC,IAAT,EAAgB;AAErC,aAAO,UAAUgB,GAAV,EAAeS,IAAf,EAAqB;AAC1BQ,QAAAA,SAAS,CAACV,GAAV,CAAcvB,IAAd,EAAoBsC,IAApB,CAAyBZ,OAAO,IAAI;AAClCS,UAAAA,GAAG,CAACI,IAAJ,CAASN,SAAS,CAACT,QAAV,CAAmBC,IAAnB,EAAwBC,OAAxB,CAAT;AACD,SAFD;AAGD,OAJD;AAKD,KAPD;;AASAS,IAAAA,GAAG,CAACK,MAAJ,GAAaL,GAAG,CAACpB,MAAjB;;AACAoB,IAAAA,GAAG,CAACpB,MAAJ,GAAa,UAAUf,IAAV,EAAgByC,OAAhB,EAAyBC,QAAzB,EAAmC;AAC9C,WAAKF,MAAL,CAAYxC,IAAZ,EAAkByC,OAAlB,EAA2BJ,cAAc,CAACrC,IAAD,CAAzC;AACD,KAFD;;AAIA,WAAOoC,IAAI,EAAX;AACD,GAhBD;;AAkBA,SAAOrB,MAAP;AAED,CAtBD","sourcesContent":["import fs from 'fs';\nimport sass from 'node-sass';\n\nconst NODE_ENV = process.env.NODE_ENV;\n\nexport class InlineCSSAMP {\n  constructor({\n    CSSPathBase,\n    CSSFilePath,\n    CSSMinify = true,\n    outFile,\n    version,\n  }) {\n    this.CSSOutDefault = `/tmp/generate-by-express-inline-css-amp-${version}.css`;\n    this.CSSFilePath = CSSFilePath;\n    this.CSSMinify = CSSMinify;\n    this.CSSPathBase = CSSPathBase;\n    this.outFile = outFile || this.CSSOutDefault\n    this.version = version;\n    this.pathToReadCSS =  this.outFile;\n  }\n\n  async generateCSS(view) {\n    this.pathToReadCSS = `${this.CSSPathBase}${view}.scss`;\n    const response = fs.existsSync(`${this.CSSPathBase}${view}.scss`)\n    if (response) {\n      this.outFileTemp = `/tmp/generate-by-express-inline-css-amp-${this.version}-${view}.scss`;\n      this.CSSFilePathTemp = this.pathToReadCSS;\n    } else {\n      this.CSSFilePathTemp = this.CSSFilePath;\n      this.pathToReadCSS = this.outFile;\n      this.outFileTemp  = this.outFile;\n    }\n\n\n    return new Promise((resolve, reject) => {\n      let options = {\n        file: this.CSSFilePathTemp,\n        outFile: this.outFileTemp,\n        outputStyle: this.CSSMinify ? 'compressed' : '',\n      }\n      \n      if (NODE_ENV != 'development') {\n        console.log('Production');\n        if (fs.existsSync(this.outFileTemp) && fs.existsSync(this.CSSOutDefault)) {\n          return  resolve();\n        } else {\n          if(!fs.existsSync(this.CSSFilePathTemp) && fs.existsSync(this.CSSOutDefault)) {\n            return  resolve();\n          }\n        }\n      }\n\n      try {\n        sass.render(options, (err, result) => {\n          if(err) {\n            console.error(err);\n            return reject(err);\n          }\n          fs.writeFile(this.outFileTemp, result.css, function(err){\n          });\n        });\n      }\n      catch(err) {\n        throw err\n      }\n      resolve();\n    })\n  }\n  \n  readCSS() {\n    return new Promise((resolve, reject) => {\n      try {\n        fs.readFile(this.pathToReadCSS, 'utf8', (err, file) => {\n          return resolve(file)\n        })\n      }\n      catch(err) {\n        throw err\n      }\n    })\n  }\n  \n  async run (view) {\n    await this.generateCSS(view);\n    return this.readCSS();\n  }\n  \n  tagStyle(html, content) {\n    const er = /(<\\/head>)/i;\n    if (!er.test(html)) return html;\n    return html.replace(er, `<style amp-custom>${content}</style>$1`);\n  }\n}\n\nmodule.exports = object => {\n  const inlinecss = new InlineCSSAMP(object);\n  const render = (req, res, next) => {\n    const renderCallback = function(view)  {\n     \n      return function (err, html) {\n        inlinecss.run(view).then(content => {\n          res.send(inlinecss.tagStyle(html,content));\n        })\n      }\n    }\n\n    res.Render = res.render\n    res.render = function (view, renders, callback) {\n      this.Render(view, renders, renderCallback(view))\n    }\n\n    return next()\n  }\n\n  return render;\n\n}\n\n"],"file":"index.js"}